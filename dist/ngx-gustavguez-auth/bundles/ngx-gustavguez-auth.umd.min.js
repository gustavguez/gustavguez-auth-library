!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("angular-2-local-storage"),require("ngx-gustavguez-core"),require("rxjs"),require("rxjs/operators"),require("@angular/common/http"),require("@angular/common"),require("@angular/forms")):"function"==typeof define&&define.amd?define("ngx-gustavguez-auth",["exports","@angular/core","angular-2-local-storage","ngx-gustavguez-core","rxjs","rxjs/operators","@angular/common/http","@angular/common","@angular/forms"],t):t((e=e||self)["ngx-gustavguez-auth"]={},e.ng.core,e.angular2LocalStorage,e.ngxGustavguezCore,e.rxjs,e.rxjs.operators,e.ng.common.http,e.ng.common,e.ng.forms)}(this,(function(e,t,n,r,o,s,i,a,u){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation. All rights reserved.
    Licensed under the Apache License, Version 2.0 (the "License"); you may not use
    this file except in compliance with the License. You may obtain a copy of the
    License at http://www.apache.org/licenses/LICENSE-2.0

    THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
    WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
    MERCHANTABLITY OR NON-INFRINGEMENT.

    See the Apache Version 2.0 License for specific language governing permissions
    and limitations under the License.
    ***************************************************************************** */function c(e,t,n,r){var o,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(o=e[a])&&(i=(s<3?o(i):s>3?o(t,n,i):o(t,n))||i);return s>3&&i&&Object.defineProperty(t,n,i),i}var g=function(e,t,n){this.token=e,this.refreshToken=t,this.expiration=n},p=function(e,t){this.username=e,this.avatar=t},h=function(){function e(e,t,n,r,o,s){this.id=e,this.username=t,this.firstName=n,this.lastName=r,this.profileImage=o,this.data=s}return e.prototype.fromJSON=function(e){e&&(this.id=e.id,this.username=e.username,this.firstName=e.firstName,this.lastName=e.lastName,this.profileImage=e.profileImage)},e}(),l=function(e,t,n,r,o,s,i,a,u,c){this.grantType=e,this.grantTypeRefresh=t,this.clientId=n,this.clientSecret=r,this.accessTokenLsKey=o,this.lastMeAvatarLsKey=s,this.lastMeUsernameLsKey=i,this.oauthUri=a,this.oauthRefreshUri=u,this.oauthMeUri=c},f=function(){function e(e,n){this.storageService=e,this.apiService=n,this.onSessionStateChange=new t.EventEmitter,this.onMeChanged=new t.EventEmitter,this.onMeParsed=new t.EventEmitter,this.config=new l}return e.prototype.setConfig=function(e){this.config=e},e.prototype.getLastMe=function(){return this.lastMe},e.prototype.getAccessToken=function(){return this.accessToken},e.prototype.getMe=function(){return this.me},e.prototype.getMeJsonResponse=function(){return this.meJsonResponse},e.prototype.isLogged=function(){return!!this.me},e.prototype.getOnSessionStateChange=function(){return this.onSessionStateChange},e.prototype.getOnMeChanged=function(){return this.onMeChanged},e.prototype.getOnMeParsed=function(){return this.onMeParsed},e.prototype.login=function(e,t){var n=this;return new o.Observable((function(r){n.apiService.changeApiResponseStrategy("root"),n.apiService.createObj(n.config.oauthUri,{username:e,password:t,grant_type:n.config.grantType,client_id:n.config.clientId,client_secret:n.config.clientSecret}).pipe(s.map((function(e){return e.data&&n.storageService.set(n.config.accessTokenLsKey,e.data),n.parseAccessToken(e.data)}))).subscribe((function(e){n.accessToken=e,n.apiService.setAccessToken(n.accessToken.token),n.config.oauthMeUri?n.requestMe().subscribe((function(){n.checkAndNotifyMeState(),n.apiService.restoreApiResponseStrategy(),r.next(!0),r.complete()}),(function(){r.error(e)})):(n.apiService.restoreApiResponseStrategy(),r.next(!0),r.complete())}),(function(e){r.error(e)}))}))},e.prototype.requestMe=function(){var e=this;return this.apiService.changeApiResponseStrategy("data"),this.apiService.fetchData(this.config.oauthMeUri).pipe(s.map((function(t){return e.me=new h,e.me.fromJSON(t.data.me),e.meJsonResponse=t.data,e.onMeParsed.emit(t.data),e.onMeChanged.emit(e.me),e.lastMe=new p,e.lastMe.avatar=e.me.profileImage,e.lastMe.username=e.me.username,e.storageService.set(e.config.lastMeAvatarLsKey,e.me.profileImage),e.storageService.set(e.config.lastMeUsernameLsKey,e.me.username),e.apiService.restoreApiResponseStrategy(),e.me})))},e.prototype.refreshToken=function(){var e=this,t=this.accessToken instanceof g?this.accessToken.refreshToken:"";return this.apiService.changeApiResponseStrategy("root"),this.apiService.createObj(this.config.oauthUri,{refresh_token:t,grant_type:this.config.grantTypeRefresh,client_id:this.config.clientId}).pipe(s.map((function(n){return n.data&&(n.data.refresh_token=t,e.storageService.set(e.config.accessTokenLsKey,n.data)),e.accessToken=e.parseAccessToken(n.data),e.apiService.setAccessToken(e.accessToken.token),e.apiService.restoreApiResponseStrategy(),e.accessToken})))},e.prototype.loadSession=function(){var e=this;return new o.Observable((function(t){var n=e.storageService.get(e.config.accessTokenLsKey),r=e.storageService.get(e.config.lastMeAvatarLsKey),o=e.storageService.get(e.config.lastMeUsernameLsKey),s=function(e){t.next(e),t.complete()};e.lastMe=o||o?new p(o,r):null,n?(e.accessToken=e.parseAccessToken(n),e.accessToken instanceof g?e.config.oauthMeUri?(e.apiService.setAccessToken(e.accessToken.token),e.requestMe().subscribe((function(){e.checkAndNotifyMeState(),s(!0)}),(function(){s(!1)}))):s(!0):s(!1)):s(!1)}))},e.prototype.logout=function(){this.storageService.remove(this.config.accessTokenLsKey),this.me=null,this.accessToken=null,this.checkAndNotifyMeState()},e.prototype.checkAndNotifyMeState=function(){this.me instanceof h&&this.accessToken instanceof g?this.onSessionStateChange.emit(!0):this.onSessionStateChange.emit(!1)},e.prototype.updateMe=function(e){this.me=e,this.onMeChanged.emit(e)},e.prototype.parseAccessToken=function(e){var t=null;if(e&&e.access_token){var n=new Date,r=e.expires_in/60;n.setMinutes(n.getMinutes()+r),t=new g(e.access_token,e.refresh_token,n)}return t},e.ctorParameters=function(){return[{type:n.LocalStorageService},{type:r.ApiService}]},e.ɵprov=t["ɵɵdefineInjectable"]({factory:function(){return new e(t["ɵɵinject"](n.LocalStorageService),t["ɵɵinject"](r.ApiService))},token:e,providedIn:"root"}),e=c([t.Injectable({providedIn:"root"})],e)}(),m=function(){function e(e){this.ngxGustavguezAuthService=e}return e.prototype.canActivate=function(){return!!this.ngxGustavguezAuthService.isLogged()||(this.ngxGustavguezAuthService.checkAndNotifyMeState(),!1)},e.ctorParameters=function(){return[{type:f}]},e.ɵprov=t["ɵɵdefineInjectable"]({factory:function(){return new e(t["ɵɵinject"](f))},token:e,providedIn:"root"}),e=c([t.Injectable({providedIn:"root"})],e)}(),d=function(){function e(e){this.ngxGustavguezAuthService=e,this.isRefreshingToken=!1,this.tokenSubject=new o.BehaviorSubject(null)}return e.prototype.intercept=function(e,t){var n=this;return t.handle(e).pipe(s.catchError((function(r){if(r instanceof i.HttpErrorResponse)switch(r.status){case 400:return n.handle400Error(r);case 401:return n.handle401Error(r,e,t);case 403:return n.handle403Error(r);default:return o.throwError(r)}return new o.Observable})))},e.prototype.addToken=function(e,t){return e.clone({setHeaders:{Authorization:"Bearer "+t}})},e.prototype.logout=function(e){return this.ngxGustavguezAuthService.logout(),o.throwError(e)},e.prototype.handle403Error=function(e){return this.logout(e.message)},e.prototype.handle401Error=function(e,t,n){var r=this;return t.url.includes("/oauth")?o.throwError(e):this.isRefreshingToken?this.tokenSubject.pipe(s.filter((function(e){return null!==e})),s.take(1),s.switchMap((function(e){return n.handle(r.addToken(t,e))}))):(this.isRefreshingToken=!0,this.tokenSubject.next(null),this.ngxGustavguezAuthService.refreshToken().pipe(s.switchMap((function(e){return e instanceof g?(r.tokenSubject.next(e.token),n.handle(r.addToken(t,e.token))):r.logout("Cant get a new token.")})),s.catchError((function(e){return r.logout(e.message)})),s.finalize((function(){return r.isRefreshingToken=!1}))))},e.prototype.handle400Error=function(e){return e instanceof i.HttpErrorResponse&&400===e.status&&"error"in e&&"invalid_grant"===e.error.error?this.logout(e.message):o.throwError(e)},e.ctorParameters=function(){return[{type:f}]},e=c([t.Injectable()],e)}(),v=function(){function e(e,n){this.ngxGustavguezAuthService=e,this.fb=n,this.onSuccess=new t.EventEmitter,this.onError=new t.EventEmitter}return e.prototype.ngOnInit=function(){if(this.loading=!1,this.ngxGustavguezAuthService.getLastMe()instanceof p){var e=this.ngxGustavguezAuthService.getLastMe();this.lastAvatar=this.imageUrl+e.avatar,this.lastUsername=e.username}this.form=this.fb.group({username:this.fb.control("",[u.Validators.required]),password:this.fb.control("",[u.Validators.required])}),this.ngxGustavguezAuthService.isLogged()?this.onSuccess.emit():this.initForm()},e.prototype.onSubmit=function(){var e=this;this.loading||(this.form.valid?(this.loading=!0,this.ngxGustavguezAuthService.login(this.form.value.username,this.form.value.password).subscribe((function(t){e.loading=!1,t&&e.onSuccess.emit()}),(function(t){e.loading=!1,e.onError.emit(t)}))):r.FormUtility.validateAllFormFields(this.form))},e.prototype.onUsernameChange=function(){this.lastUsername!==this.form.value.username&&(this.lastAvatar=null)},e.prototype.initForm=function(){this.form.reset(),this.lastUsername&&this.form.patchValue({username:this.lastUsername}),this.loading=!1},e.ctorParameters=function(){return[{type:f},{type:u.FormBuilder}]},c([t.Input()],e.prototype,"imageUrl",void 0),c([t.Input()],e.prototype,"usernamePlaceholder",void 0),c([t.Input()],e.prototype,"passwordPlaceholder",void 0),c([t.Input()],e.prototype,"submitText",void 0),c([t.Output()],e.prototype,"onSuccess",void 0),c([t.Output()],e.prototype,"onError",void 0),e=c([t.Component({selector:"ngx-gustavguez-auth-login",template:'<form [formGroup]="form" (submit)="onSubmit()">\n\t\t\t\t\t\n\t<div class="logo text-center">\n\t\t<div \n\t\t\t[style.background]="\'url(\' + (lastAvatar ? lastAvatar : \'assets/images/logo.png\') + \')\'" \n\t\t\tclass="img rounded-circle border border-dark"></div>\n\t</div>\n\n\t<ngx-gustavguez-input-holder \n\t\tcontrolName="username"\n\t\t[form]="form">\n\t\t<input \n\t\t\ttype="text" \n\t\t\tclass="form-control" \n\t\t\tformControlName="username"\n\t\t\ttype="text" \n\t\t\t(change)="onUsernameChange()"\n\t\t\t[placeholder]="usernamePlaceholder ? usernamePlaceholder : \'\'">\n\t</ngx-gustavguez-input-holder>\n\n\t<ngx-gustavguez-input-holder \n\t\tcontrolName="password"\n\t\t[form]="form">\n\t\t<input \n\t\t\ttype="password" \n\t\t\tclass="form-control" \n\t\t\tformControlName="password"\n\t\t\t[placeholder]="passwordPlaceholder ? passwordPlaceholder : \'\'" \n\t\t\tautocomplete="false">\n\t</ngx-gustavguez-input-holder>\n\t\n\t<div class="form-group">\n\t\t<ngx-gustavguez-submit \n\t\t\t[loading]="loading"\n\t\t\t[text]="submitText ? submitText : \'Login\'"></ngx-gustavguez-submit>\n\t</div>      \n</form>',styles:[".logo .img{width:110px;height:110px;background-size:contain!important;margin-bottom:10px;display:inline-block;background-repeat:no-repeat!important;background-position:center center!important}"]})],e)}(),y=function(){function e(){}return e=c([t.NgModule({declarations:[v],imports:[a.CommonModule,n.LocalStorageModule,u.ReactiveFormsModule,r.NgxGustavguezCoreModule],providers:[{provide:i.HTTP_INTERCEPTORS,useClass:d,multi:!0}],exports:[v]})],e)}();e.NgxGustavguezAccessTokenModel=g,e.NgxGustavguezAuthGuard=m,e.NgxGustavguezAuthInterceptor=d,e.NgxGustavguezAuthLoginComponent=v,e.NgxGustavguezAuthModule=y,e.NgxGustavguezAuthService=f,e.NgxGustavguezConfigModel=l,e.NgxGustavguezLastMeModel=p,e.NgxGustavguezMeModel=h,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=ngx-gustavguez-auth.umd.min.js.map